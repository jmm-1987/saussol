{% extends "base.html" %}

{% block title %}Factura {{ factura.numero_factura }} - Taller de Automoción{% endblock %}

{% block content %}
<div class="card">
    <h2>Factura: {{ factura.numero_factura }}</h2>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
        <div>
            <strong>Cliente:</strong><br>
            {{ factura.cliente.nombre }}<br>
            {% if factura.cliente.dni %}{{ factura.cliente.dni }}<br>{% endif %}
            {% if factura.cliente.direccion %}{{ factura.cliente.direccion }}{% endif %}
        </div>
        <div>
            <strong>Fecha:</strong> {{ factura.fecha.strftime('%d/%m/%Y') }}<br>
            <strong>Estado Verifactu:</strong> 
            {% if factura.enviada_verifactu %}
                <span style="color: green;">✓ Enviada</span>
                {% if factura.fecha_envio_verifactu %}
                    <br><small>{{ factura.fecha_envio_verifactu.strftime('%d/%m/%Y %H:%M') }}</small>
                {% endif %}
            {% else %}
                <span style="color: orange;">Pendiente</span>
            {% endif %}
        </div>
    </div>
    
    <h3>Intervenciones</h3>
    {% if factura.intervenciones %}
    <table>
        <thead>
            <tr>
                <th>Vehículo</th>
                <th>Fecha</th>
                <th>Descripción</th>
                <th>Precio</th>
            </tr>
        </thead>
        <tbody>
            {% for intervencion in factura.intervenciones %}
            <tr>
                <td>{{ intervencion.coche.matricula }}</td>
                <td>{{ intervencion.fecha.strftime('%d/%m/%Y') }}</td>
                <td>{{ intervencion.descripcion }}</td>
                <td>{{ "%.2f"|format(intervencion.precio) }} €</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <td colspan="3" style="text-align: right; padding-top: 15px; border-top: 2px solid #ddd;"><strong>Base Imponible:</strong></td>
                <td style="padding-top: 15px; border-top: 2px solid #ddd;"><strong>{{ "%.2f"|format(factura.base_imponible) }} €</strong></td>
            </tr>
            {% if factura.descuento_porcentaje > 0 %}
            <tr>
                <td colspan="3" style="text-align: right; color: #dc2626;"><strong>Descuento ({{ "%.2f"|format(factura.descuento_porcentaje) }}%):</strong></td>
                <td style="color: #dc2626;"><strong>-{{ "%.2f"|format(factura.descuento_importe) }} €</strong></td>
            </tr>
            <tr>
                <td colspan="3" style="text-align: right; padding-bottom: 10px; border-bottom: 1px solid #eee;"><strong>Base después de descuento:</strong></td>
                <td style="padding-bottom: 10px; border-bottom: 1px solid #eee;"><strong>{{ "%.2f"|format(factura.base_imponible - factura.descuento_importe) }} €</strong></td>
            </tr>
            {% endif %}
            <tr>
                <td colspan="3" style="text-align: right;"><strong>IVA ({{ "%.2f"|format(factura.iva_porcentaje) }}%):</strong></td>
                <td><strong>{{ "%.2f"|format(factura.iva_importe) }} €</strong></td>
            </tr>
            <tr style="background-color: #16a34a; color: white; font-weight: bold; font-size: 1.1em;">
                <td colspan="3" style="text-align: right; padding: 15px;">TOTAL:</td>
                <td style="padding: 15px;">{{ "%.2f"|format(factura.total) }} €</td>
            </tr>
        </tfoot>
    </table>
    {% endif %}
    
    <div class="actions" style="margin-top: 20px;">
        <a href="{{ url_for('descargar_pdf_factura', id=factura.id) }}" class="btn btn-primary">Descargar PDF</a>
        {% if not factura.enviada_verifactu %}
        <form method="POST" action="{{ url_for('enviar_verifactu', id=factura.id) }}" style="display: inline;" onsubmit="return confirm('¿Enviar esta factura a Verifactu?');">
            <button type="submit" class="btn btn-success">Enviar a Verifactu</button>
        </form>
        {% endif %}
        <a href="{{ url_for('listar_facturas') }}" class="btn btn-secondary">Volver</a>
    </div>
</div>
{% endblock %}


